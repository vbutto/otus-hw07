<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Forecast Service</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            min-height: 100vh;
        }

        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #2d3436;
            margin: 0;
        }

        .status {
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            text-align: center;
        }

        .loading {
            background: #74b9ff;
            color: white;
        }

        .success {
            background: #00b894;
            color: white;
        }

        .error {
            background: #ff7675;
            color: white;
        }

        .weather-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .weather-item {
            background: white;
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #74b9ff;
        }

        .coordinates {
            background: #e8f4f8;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9em;
            color: #636e72;
            margin: 10px 0;
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            color: #636e72;
            font-size: 0.9em;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #74b9ff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üå§Ô∏è Weather Forecast Service</h1>
            <p>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∏ –ø—Ä–æ–≥–Ω–æ–∑ –ø–æ–≥–æ–¥—ã</p>
        </div>

        <div id="status" class="status loading">
            <div class="spinner"></div>
            –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ...
        </div>

        <div id="coordinates" class="coordinates" style="display: none;"></div>

        <div id="weather" style="display: none;"></div>

        <div class="footer">
            <p>Serverless Weather Service</p>
            <p>API Gateway ‚Üí Function 1 (Context) ‚Üí Function 2 (Forecast) ‚Üí Yandex Weather API</p>
            <p>Powered by Yandex Cloud</p>
        </div>
    </div>

    <script>
        const API_BASE_URL = '${api_gateway_url}';

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', function () {
            getLocationAndWeather();
        });

        function getLocationAndWeather() {
            if (!navigator.geolocation) {
                showError('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º');
                return;
            }

            const options = {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 300000
            };

            navigator.geolocation.getCurrentPosition(
                function (position) {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    showCoordinates(lat, lon, position.coords.accuracy);
                    getWeather(lat, lon);
                },
                function (error) {
                    let message = '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ: ';
                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            message += '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é –≤ –±—Ä–∞—É–∑–µ—Ä–µ.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            message += '–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ.';
                            break;
                        case error.TIMEOUT:
                            message += '–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è.';
                            break;
                        default:
                            message += '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.';
                    }
                    showError(message);
                },
                options
            );
        }

        function showCoordinates(lat, lon, accuracy) {
            const coordsDiv = document.getElementById('coordinates');
            coordsDiv.style.display = 'block';
            coordsDiv.innerHTML = `
                <strong>üìç –í–∞—à–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:</strong><br>
                –®–∏—Ä–æ—Ç–∞: ${lat.toFixed(6)}<br>
                –î–æ–ª–≥–æ—Ç–∞: ${lon.toFixed(6)}<br>
                ${accuracy ? `–¢–æ—á–Ω–æ—Å—Ç—å: ¬±${Math.round(accuracy)} –º–µ—Ç—Ä–æ–≤` : ''}
            `;
        }

        async function getWeather(lat, lon) {
            try {
                showStatus('–ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–≥–Ω–æ–∑ –ø–æ–≥–æ–¥—ã...', 'loading');

                const userId = 'web_' + Math.random().toString(36).substr(2, 9);
                const days = 5;

                const response = await fetch(
                    `${API_BASE_URL}/weather?lat=${lat}&lon=${lon}&days=${days}&user_id=${userId}`
                );

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                showWeather(data);
                showStatus('–ü—Ä–æ–≥–Ω–æ–∑ –ø–æ–≥–æ–¥—ã —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω!', 'success');

            } catch (error) {
                console.error('Weather API error:', error);
                showError(`–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–≥–æ–¥—ã: ${error.message}`);
            }
        }

        function showWeather(data) {
            const weatherDiv = document.getElementById('weather');
            weatherDiv.style.display = 'block';

            let weatherHtml = `
                <div class="weather-info">
                    <h3>üåç ${data.location}${data.country ? ', ' + data.country : ''}</h3>
                    <p>–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ ${data.forecast_days} –¥–Ω–µ–π:</p>
                    ${data.note ? `<p style="color: #e17055; font-style: italic;">‚ö†Ô∏è ${data.note}</p>` : ''}
                    ${data.forecast.map(day => {
                const date = new Date(day.date);
                const dateStr = date.toLocaleDateString('ru-RU', {
                    weekday: 'long',
                    day: 'numeric',
                    month: 'long'
                });
                return `
                            <div class="weather-item">
                                <strong>${dateStr}</strong><br>
                                <div style="font-size: 1.5em; color: #74b9ff; margin: 10px 0;">
                                    ${getWeatherIcon(day.weather.main)} ${day.temperature.day}¬∞C
                                </div>
                                <div style="color: #636e72;">
                                    ${day.weather.description}<br>
                                    üå°Ô∏è –æ—Ç ${day.temperature.min}¬∞ –¥–æ ${day.temperature.max}¬∞C<br>
                                    ü§ö –û—â—É—â–∞–µ—Ç—Å—è –∫–∞–∫ ${day.temperature.feels_like}¬∞C<br>
                                    üí® –í–µ—Ç–µ—Ä: ${day.wind_speed} –º/—Å<br>
                                    üíß –í–ª–∞–∂–Ω–æ—Å—Ç—å: ${day.humidity}%<br>
                                    ‚òÅÔ∏è –û–±–ª–∞—á–Ω–æ—Å—Ç—å: ${day.clouds}%
                                </div>
                            </div>
                        `;
            }).join('')}
                    <p style="text-align: center; color: #636e72; font-size: 0.9em; margin-top: 20px;">
                        üìä –ò—Å—Ç–æ—á–Ω–∏–∫: ${data.data_source || 'Yandex Weather API'}<br>
                        üìÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã: ${new Date(data.generated_at).toLocaleString('ru-RU')}
                    </p>
                </div>
            `;

            weatherDiv.innerHTML = weatherHtml;
        }

        function getWeatherIcon(weatherMain) {
            const icons = {
                'Clear': '‚òÄÔ∏è',
                'Clouds': '‚òÅÔ∏è',
                'Rain': 'üåßÔ∏è',
                'Drizzle': 'üå¶Ô∏è',
                'Thunderstorm': '‚õàÔ∏è',
                'Snow': '‚ùÑÔ∏è',
                'Mist': 'üå´Ô∏è',
                'Fog': 'üå´Ô∏è'
            };
            return icons[weatherMain] || 'üå§Ô∏è';
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;

            if (type === 'loading') {
                statusDiv.innerHTML = `
                    <div class="spinner"></div>
                    ${message}
                `;
            } else {
                statusDiv.innerHTML = message;
            }
        }

        function showError(message) {
            showStatus(message, 'error');

            // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                document.getElementById('status').style.display = 'none';
            }, 10000);
        }
    </script>
</body>

</html>